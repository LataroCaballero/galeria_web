---
export const prerender = false;

import BaseLayout from '../../layouts/BaseLayout.astro';
import Navbar from '../../components/Navbar.astro';
import CatalogCard from '../../components/public/CatalogCard.astro';
import CategoryFilter from '../../components/public/CategoryFilter.astro';

let categorySlug = Astro.url.searchParams.get('categoria') || undefined;
const search = Astro.url.searchParams.get('q') || undefined;
const currentPage = Math.max(1, Number(Astro.url.searchParams.get('page')) || 1);
const ITEMS_PER_PAGE = 12;

const API = import.meta.env.PUBLIC_API_URL;

let products: any[] = [];
let categories: any[] = [];
let totalPages = 1;

Astro.response.headers.set('Cache-Control', 'public, s-maxage=300, stale-while-revalidate=600');

try {
  // Fetch categories first to determine default
  const categoriesRes = await fetch(`${API}/categories`);
  if (categoriesRes.ok) {
    const data = await categoriesRes.json();
    categories = data.data || data || [];
  }

  // If no category selected, use the first one
  if (!categorySlug && categories.length > 0) {
    categorySlug = categories[0].slug;
  }

  const params = new URLSearchParams();
  if (categorySlug) params.set('category', categorySlug);
  if (search) params.set('search', search);
  params.set('limit', String(ITEMS_PER_PAGE));
  params.set('page', String(currentPage));

  const productsRes = await fetch(`${API}/products?${params}`);
  if (productsRes.ok) {
    const data = await productsRes.json();
    products = data.data?.data || data.data || [];
    totalPages = data.data?.meta?.totalPages || data.meta?.totalPages || 1;
  }
} catch (e) {
  // API not available
}

function buildPageUrl(page: number) {
  const url = new URL(Astro.url);
  // Ensure category is always in pagination links
  if (categorySlug) url.searchParams.set('categoria', categorySlug);
  if (page <= 1) {
    url.searchParams.delete('page');
  } else {
    url.searchParams.set('page', String(page));
  }
  return url.pathname + url.search;
}
---

<BaseLayout title="Shop · GALERÍA" description="Catalogo de mobiliario, decoracion y arte - Galeria Estudio">
  <Navbar />

  <main class="pt-28 pb-24 px-6 md:px-20 bg-[#F5F1E4] min-h-screen">
    <!-- Filters -->
    <div class="max-w-7xl mx-auto">
      <CategoryFilter categories={categories} activeCategory={categorySlug} />
    </div>

    <!-- Product Grid -->
    <div class="max-w-7xl mx-auto grid grid-cols-2 sm:grid-cols-3 gap-1">
      {products.map((product: any) => {
        const primaryImage = product.images?.find((i: any) => i.isPrimary) || product.images?.[0];
        return (
          <CatalogCard
            name={product.name}
            slug={product.slug}
            imageUrl={primaryImage?.cloudinaryUrl || '/images/shop.jpg'}
            imageAlt={primaryImage?.altText || product.name}
            category={product.category?.name}
          />
        );
      })}
    </div>

    <!-- Empty state -->
    {products.length === 0 && (
      <div class="text-center py-20 max-w-7xl mx-auto">
        <p class="font-serif text-tinta/60">No se encontraron productos.</p>
      </div>
    )}

    <!-- Pagination -->
    {totalPages > 1 && (
      <nav class="max-w-7xl mx-auto flex justify-center items-center gap-6 mt-16">
        {currentPage > 1 ? (
          <a
            href={buildPageUrl(currentPage - 1)}
            class="font-serif text-sm uppercase tracking-tightish text-tinta hover:opacity-70 transition no-underline"
          >
            &larr; Anterior
          </a>
        ) : (
          <span class="font-serif text-sm uppercase tracking-tightish text-tinta/30">
            &larr; Anterior
          </span>
        )}

        <span class="font-serif text-sm text-tinta/60">
          {currentPage} / {totalPages}
        </span>

        {currentPage < totalPages ? (
          <a
            href={buildPageUrl(currentPage + 1)}
            class="font-serif text-sm uppercase tracking-tightish text-tinta hover:opacity-70 transition no-underline"
          >
            Siguiente &rarr;
          </a>
        ) : (
          <span class="font-serif text-sm uppercase tracking-tightish text-tinta/30">
            Siguiente &rarr;
          </span>
        )}
      </nav>
    )}
  </main>
</BaseLayout>
