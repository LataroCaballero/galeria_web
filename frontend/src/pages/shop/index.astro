---
export const prerender = false;

import BaseLayout from '../../layouts/BaseLayout.astro';
import Navbar from '../../components/Navbar.astro';
import CatalogCard from '../../components/public/CatalogCard.astro';
import CategoryFilter from '../../components/public/CategoryFilter.astro';

const categorySlug = Astro.url.searchParams.get('categoria') || undefined;
const search = Astro.url.searchParams.get('q') || undefined;

const API = import.meta.env.PUBLIC_API_URL;

let products: any[] = [];
let categories: any[] = [];

try {
  const params = new URLSearchParams();
  if (categorySlug) params.set('category', categorySlug);
  if (search) params.set('search', search);
  params.set('limit', '50');

  const [productsRes, categoriesRes] = await Promise.all([
    fetch(`${API}/products?${params}`),
    fetch(`${API}/categories`),
  ]);

  if (productsRes.ok) {
    const data = await productsRes.json();
    products = data.data?.data || data.data || [];
  }

  if (categoriesRes.ok) {
    const data = await categoriesRes.json();
    categories = data.data || data || [];
  }
} catch (e) {
  // API not available
}
---

<BaseLayout title="Shop · GALERÍA" description="Catalogo de mobiliario, decoracion y arte - Galeria Estudio">
  <Navbar />

  <main class="pt-28 pb-24 px-6 md:px-20 bg-[#F5F1E4] min-h-screen">
    <!-- Page heading -->
    <div class="max-w-7xl mx-auto mb-12">
      <h1 class="font-serif text-lg md:text-2xl font-bold uppercase tracking-tightish">
        SHOP
      </h1>
    </div>

    <!-- Filters -->
    <div class="max-w-7xl mx-auto">
      <CategoryFilter categories={categories} activeCategory={categorySlug} />
    </div>

    <!-- Product Grid -->
    <div class="max-w-7xl mx-auto grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-12">
      {products.map((product: any) => {
        const primaryImage = product.images?.find((i: any) => i.isPrimary) || product.images?.[0];
        return (
          <CatalogCard
            name={product.name}
            slug={product.slug}
            imageUrl={primaryImage?.cloudinaryUrl || '/images/shop.jpg'}
            imageAlt={primaryImage?.altText || product.name}
            category={product.category?.name}
          />
        );
      })}
    </div>

    <!-- Empty state -->
    {products.length === 0 && (
      <div class="text-center py-20 max-w-7xl mx-auto">
        <p class="font-serif text-tinta/60">No se encontraron productos.</p>
      </div>
    )}
  </main>
</BaseLayout>
