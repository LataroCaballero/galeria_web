---
export const prerender = false;

import BaseLayout from '../../layouts/BaseLayout.astro';
import Navbar from '../../components/Navbar.astro';
import { cloudinaryUrl } from '../../lib/cloudinary';

const { slug } = Astro.params;
const API = import.meta.env.PUBLIC_API_URL;

let product: any = null;

try {
  const res = await fetch(`${API}/products/${slug}`);
  if (res.ok) {
    const data = await res.json();
    product = data.data || data;
  }
} catch (e) {
  // Product not found
}

if (!product) {
  return Astro.redirect('/shop');
}

const primaryImage = product.images?.find((i: any) => i.isPrimary) || product.images?.[0];
const otherImages = product.images?.filter((i: any) => i.id !== primaryImage?.id) || [];

const seoTitle = `${product.name} · GALERÍA`;
const seoDescription = product.description || `Descubri ${product.name} en Galeria Estudio`;
const seoImage = primaryImage?.cloudinaryUrl || '/images/og-hero.jpg';

// Schema.org Product markup
const schemaOrg = JSON.stringify({
  "@context": "https://schema.org",
  "@type": "Product",
  name: product.name,
  description: product.description,
  image: primaryImage?.cloudinaryUrl,
  offers: {
    "@type": "Offer",
    price: product.price,
    priceCurrency: "ARS",
    availability: "https://schema.org/InStock",
  },
});
---

<BaseLayout title={seoTitle} description={seoDescription} image={seoImage}>
  <Fragment slot="head">
    <script type="application/ld+json" set:html={schemaOrg} />
  </Fragment>

  <Navbar />

  <main class="pt-28 pb-24 bg-[#F5F1E4] min-h-screen">
    <!-- Breadcrumb -->
    <nav class="max-w-5xl mx-auto px-6 md:px-20 mb-12">
      <ol class="flex justify-center gap-2 text-xs uppercase tracking-[0.12em] text-tinta/50">
        <li><a href="/shop" class="hover:text-tinta no-underline">Shop</a></li>
        <li>/</li>
        {product.category && (
          <>
            <li>
              <a href={`/shop?categoria=${product.category.slug}`} class="hover:text-tinta no-underline">
                {product.category.name}
              </a>
            </li>
            <li>/</li>
          </>
        )}
        <li class="text-tinta">{product.name}</li>
      </ol>
    </nav>

    <!-- Product Info (centered) -->
    <div class="max-w-2xl mx-auto px-6 text-center space-y-6 mb-16">
      <h1 class="font-serif text-2xl md:text-3xl font-bold uppercase tracking-tightish">
        {product.name}
      </h1>

      {product.description && (
        <p class="font-serif text-sm leading-relaxed text-tinta/80">
          {product.description}
        </p>
      )}

      {product.specifications && Object.keys(product.specifications).length > 0 && (
        <dl class="inline-flex flex-col gap-1 text-sm text-tinta/70">
          {Object.entries(product.specifications).map(([key, value]) => (
            <div>
              <dt class="inline uppercase text-xs tracking-wide">{key}:</dt>
              <dd class="inline font-serif ml-1">{value}</dd>
            </div>
          ))}
        </dl>
      )}

      <p class="font-serif text-lg text-tinta">
        ${Number(product.price).toLocaleString('es-AR')}
      </p>
    </div>

    <!-- Image Gallery (2 columns) -->
    <div class="max-w-5xl mx-auto px-6 md:px-20 grid grid-cols-1 sm:grid-cols-2 gap-1 mb-16">
      {primaryImage && (
        <div class="aspect-[4/5] overflow-hidden">
          <img
            src={cloudinaryUrl(primaryImage.cloudinaryUrl, { width: 800 })}
            alt={primaryImage.altText || product.name}
            width="800"
            height="1000"
            class="w-full h-full object-cover"
          />
        </div>
      )}
      {otherImages.map((img: any) => (
        <div class="aspect-[4/5] overflow-hidden">
          <img
            src={cloudinaryUrl(img.cloudinaryUrl, { width: 800 })}
            alt={img.altText || product.name}
            width="800"
            height="1000"
            class="w-full h-full object-cover"
            loading="lazy"
          />
        </div>
      ))}
    </div>

    <!-- CTA -->
    <div class="text-center">
      <a
        href={`https://wa.me/5492644432919?text=${encodeURIComponent(`Hola! quiero consultarles por ${product.name}, muchas gracias!`)}`}
        target="_blank"
        rel="noopener noreferrer"
        class="inline-block bg-carbón text-crema px-10 py-3 text-sm uppercase tracking-tightish hover:opacity-90 transition no-underline"
      >
        Consultar
      </a>
    </div>
  </main>
</BaseLayout>
