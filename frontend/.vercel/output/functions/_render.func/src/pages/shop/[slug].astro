---
export const prerender = false;

import BaseLayout from '../../layouts/BaseLayout.astro';
import Navbar from '../../components/Navbar.astro';

const { slug } = Astro.params;
const API = import.meta.env.PUBLIC_API_URL;

let product: any = null;

try {
  const res = await fetch(`${API}/products/${slug}`);
  if (res.ok) {
    const data = await res.json();
    product = data.data || data;
  }
} catch (e) {
  // Product not found
}

if (!product) {
  return Astro.redirect('/shop');
}

const primaryImage = product.images?.find((i: any) => i.isPrimary) || product.images?.[0];
const otherImages = product.images?.filter((i: any) => i.id !== primaryImage?.id) || [];

const seoTitle = `${product.name} · GALERÍA`;
const seoDescription = product.description || `Descubri ${product.name} en Galeria Estudio`;
const seoImage = primaryImage?.cloudinaryUrl || '/images/hero.jpg';

// Schema.org Product markup
const schemaOrg = JSON.stringify({
  "@context": "https://schema.org",
  "@type": "Product",
  name: product.name,
  description: product.description,
  image: primaryImage?.cloudinaryUrl,
  offers: {
    "@type": "Offer",
    price: product.price,
    priceCurrency: "ARS",
    availability: "https://schema.org/InStock",
  },
});
---

<BaseLayout title={seoTitle} description={seoDescription} image={seoImage}>
  <Fragment slot="head">
    <script type="application/ld+json" set:html={schemaOrg} />
  </Fragment>

  <Navbar />

  <main class="pt-28 pb-24 bg-[#F5F1E4] min-h-screen">
    <!-- Breadcrumb -->
    <nav class="max-w-7xl mx-auto px-6 md:px-20 mb-8">
      <ol class="flex gap-2 text-xs uppercase tracking-[0.12em] text-tinta/50">
        <li><a href="/shop" class="hover:text-tinta no-underline">Shop</a></li>
        <li>/</li>
        {product.category && (
          <>
            <li>
              <a href={`/shop?categoria=${product.category.slug}`} class="hover:text-tinta no-underline">
                {product.category.name}
              </a>
            </li>
            <li>/</li>
          </>
        )}
        <li class="text-tinta">{product.name}</li>
      </ol>
    </nav>

    <!-- Product Layout: 2 columns -->
    <div class="max-w-7xl mx-auto px-6 md:px-20 grid grid-cols-1 md:grid-cols-2 gap-12">
      <!-- Image Gallery -->
      <div class="space-y-4">
        {primaryImage && (
          <div class="aspect-[4/5] overflow-hidden">
            <img
              src={primaryImage.cloudinaryUrl}
              alt={primaryImage.altText || product.name}
              class="w-full h-full object-cover"
            />
          </div>
        )}
        {otherImages.map((img: any) => (
          <div class="aspect-[4/5] overflow-hidden">
            <img
              src={img.cloudinaryUrl}
              alt={img.altText || product.name}
              class="w-full h-full object-cover"
              loading="lazy"
            />
          </div>
        ))}
      </div>

      <!-- Product Info (sticky on desktop) -->
      <div class="md:sticky md:top-28 md:self-start space-y-8">
        <div>
          <h1 class="font-serif text-2xl md:text-3xl font-bold uppercase tracking-tightish mb-3">
            {product.name}
          </h1>
          <p class="font-serif text-lg text-tinta/80">
            ${Number(product.price).toLocaleString('es-AR')}
          </p>
        </div>

        {product.description && (
          <div class="font-serif text-sm leading-relaxed text-black/80 space-y-4">
            <p>{product.description}</p>
          </div>
        )}

        {product.specifications && Object.keys(product.specifications).length > 0 && (
          <div>
            <h3 class="text-xs uppercase tracking-[0.12em] font-bold mb-4">Especificaciones</h3>
            <dl class="space-y-2 text-sm">
              {Object.entries(product.specifications).map(([key, value]) => (
                <div class="flex justify-between border-b border-tinta/10 pb-2">
                  <dt class="text-tinta/60 uppercase text-xs tracking-wide">{key}</dt>
                  <dd class="font-serif">{value}</dd>
                </div>
              ))}
            </dl>
          </div>
        )}

        <a
          href="/contacto"
          class="inline-block bg-carbón text-crema px-8 py-3 text-sm uppercase tracking-tightish hover:opacity-90 transition no-underline"
        >
          Consultar
        </a>
      </div>
    </div>
  </main>
</BaseLayout>
