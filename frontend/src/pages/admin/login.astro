---
export const prerender = false;

import '../../styles/globals.css';
import { getTokenFromCookies, validateToken } from '../../lib/auth';

// If already logged in, redirect to dashboard
const token = getTokenFromCookies(Astro.request.headers.get('cookie'));
if (token) {
  const user = await validateToken(token);
  if (user) {
    return Astro.redirect('/admin');
  }
}
---

<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login - Admin Panel</title>
  <meta name="robots" content="noindex, nofollow" />
</head>
<body class="bg-[#F5F1E4] text-tinta font-serif min-h-screen flex items-center justify-center">
  <div class="w-full max-w-sm px-8">
    <div class="text-center mb-10">
      <h1 class="text-2xl uppercase tracking-tightish font-bold">Admin</h1>
      <p class="text-sm text-tinta/60 mt-2">Galeria Estudio</p>
    </div>

    <form id="loginForm" class="space-y-5">
      <div>
        <label class="block text-xs uppercase tracking-tightish mb-1 font-bold" for="email">
          Email
        </label>
        <input
          type="email"
          id="email"
          name="email"
          required
          class="w-full border border-tinta/20 bg-white px-3 py-2 text-sm font-serif focus:outline-none focus:border-tinta/60"
          placeholder="admin@galeriaestudio.com.ar"
        />
      </div>

      <div>
        <label class="block text-xs uppercase tracking-tightish mb-1 font-bold" for="password">
          Password
        </label>
        <input
          type="password"
          id="password"
          name="password"
          required
          minlength="6"
          class="w-full border border-tinta/20 bg-white px-3 py-2 text-sm font-serif focus:outline-none focus:border-tinta/60"
        />
      </div>

      <div id="errorMsg" class="text-red-600 text-xs hidden"></div>

      <button
        type="submit"
        id="submitBtn"
        class="w-full bg-carbÃ³n text-crema px-6 py-2.5 text-sm uppercase tracking-tightish hover:opacity-90 transition cursor-pointer flex items-center justify-center gap-2 disabled:opacity-50"
      >
        <svg id="loginSpinner" class="animate-spin w-4 h-4 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="#F2EBD8" stroke-width="3" />
          <path class="opacity-75" fill="#F2EBD8" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z" />
        </svg>
        <span id="submitText">Ingresar</span>
      </button>
    </form>

    <div class="text-center mt-8">
      <a href="/" class="text-xs text-tinta/50 hover:text-tinta transition">Volver al sitio</a>
    </div>
  </div>

  <script define:vars={{ apiUrl: import.meta.env.PUBLIC_API_URL }}>
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const errorMsg = document.getElementById('errorMsg');
      const submitBtn = document.getElementById('submitBtn');
      const spinner = document.getElementById('loginSpinner');
      const submitText = document.getElementById('submitText');

      errorMsg.classList.add('hidden');
      submitBtn.disabled = true;
      spinner.classList.remove('hidden');
      submitText.textContent = 'Ingresando...';

      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      try {
        const res = await fetch(`${apiUrl}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.message || 'Credenciales invalidas');
        }

        const data = await res.json();
        const token = data.data?.accessToken || data.accessToken;

        // Set cookie (7 days)
        document.cookie = `auth_token=${token}; path=/; max-age=604800; SameSite=Lax`;

        window.location.href = '/admin';
      } catch (err) {
        errorMsg.textContent = err.message;
        errorMsg.classList.remove('hidden');
        submitBtn.disabled = false;
        spinner.classList.add('hidden');
        submitText.textContent = 'Ingresar';
      }
    });
  </script>
</body>
</html>
